# Agent Instructions for Transaction Entry

This document provides instructions for AI agents to automatically add transactions and trades to this Beancount ledger.

## Repository Structure

```
balances/
├── main.bean                       # Account definitions, opening balances, includes
├── prices.bean                     # Stock prices (auto-generated by prices.py)
└── YYYY/                           # Year directory
    └── MM/                         # Month directory
        ├── Cash.bean               # Cash transactions
        ├── SG_Moomoo.bean          # Moomoo brokerage transactions
        ├── TW_ChunghwaPost.bean    # Chunghwa Post transactions
        ├── TW_LINE.bean            # LINE Bank transactions
        └── TW_Richart.bean         # Richart Bank transactions
```

## General Rules

1. **File location**: Transactions go in `YYYY/MM/<AccountName>.bean`
2. **Date format**: `YYYY-MM-DD`
3. **Indentation**: 2 spaces for posting lines
4. **Currency**: Always specify currency (USD, TWD, SGD, CNY)
5. **Formatting**: Run `make format` after adding transactions

## SG_Moomoo (Singapore Moomoo Brokerage)

**File**: `202Y/MM/SG_Moomoo.bean`
**Account**: `Assets:Investment:SG-Moomoo:Securities`

### Stock/ETF Transactions

#### Buy Stock

```beancount
YYYY-MM-DD * "Buy TICKER"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      <qty> <TICKER> @ <price> USD
  Expenses:Fees:Commissions                <commission> USD
```

**Example:**

```beancount
2026-01-02 * "Buy BOXX"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      69 BOXX @ 115.1091 USD
  Expenses:Fees:Commissions                 1.31 USD
```

#### Sell Stock

```beancount
YYYY-MM-DD * "Sell TICKER"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      -<qty> <TICKER> @ <price> USD
  Expenses:Fees:Commissions                <commission> USD
```

**Example:**

```beancount
2026-01-02 * "Sell QQQ"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      -1 QQQ @ 617.32 USD
  Expenses:Fees:Commissions                 1.09 USD
```

### Options Transactions

#### Option Ticker Format

```
<UNDERLYING>-<EXPIRY>-<STRIKE><TYPE>
```

- **UNDERLYING**: Stock ticker (e.g., TQQQ, GOOGL, DUOL)
- **EXPIRY**: YYMMDD format (e.g., 260116 = Jan 16, 2026)
- **STRIKE**: Strike price as integer
- **TYPE**: C for Call, P for Put

**Examples:**

- `TQQQ-260116-29C` = TQQQ $29 Call expiring Jan 16, 2026
- `GOOGL-270115-205C` = GOOGL $205 Call expiring Jan 15, 2027
- `DUOL-260320-340C` = DUOL $340 Call expiring Mar 20, 2026

#### Buy to Open (Long Option)

```beancount
YYYY-MM-DD * "Buy <TICKER>-<EXPIRY>-<STRIKE><TYPE>"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      <contracts * 100> <OPTION_TICKER> @ <premium> USD
  Expenses:Fees:Commissions                <commission> USD
```

#### Sell to Open (Short Option)

```beancount
YYYY-MM-DD * "Sell <TICKER>-<EXPIRY>-<STRIKE><TYPE>"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities      -<contracts * 100> <OPTION_TICKER> @ <premium> USD
  Expenses:Fees:Commissions                <commission> USD
```

#### Close Option Spread

When closing a spread (e.g., closing both legs of a call spread):

```beancount
YYYY-MM-DD * "Close <UNDERLYING>-<EXPIRY>-<STRIKE1><TYPE>-<STRIKE2><TYPE>"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities   <qty> <SHORT_OPTION> @ <price> USD
  Assets:Investment:SG-Moomoo:Securities  -<qty> <LONG_OPTION> @ <price> USD
  Expenses:Fees:Commissions                <commission> USD
```

**Example (closing a call spread):**

```beancount
2026-01-12 * "Close TQQQ-260116-29C-34C"
  Assets:Investment:SG-Moomoo:Securities
  Assets:Investment:SG-Moomoo:Securities   1,200 TQQQ-260116-34C @ 20.60 USD
  Assets:Investment:SG-Moomoo:Securities  -1,200 TQQQ-260116-29C @ 25.58 USD
  Expenses:Fees:Commissions                32.29 USD
```

### Rounding Adjustments

When cash balance doesn't match due to decimal precision:

```beancount
YYYY-MM-DD * "Rounding"
  Assets:Investment:SG-Moomoo:Securities    <amount> USD
  Equity:Rounding
```

**Example:**

```beancount
2026-01-12 * "Rounding"
  Assets:Investment:SG-Moomoo:Securities    0.02 USD
  Equity:Rounding
```

### Important Notes for SG_Moomoo

1. **Quantity sign**: Positive for buy, negative for sell
2. **Option multiplier**: Options are tracked per share (100 shares per contract), so 1 contract = 100 units
3. **Price precision**: Use full precision from trade confirmation (e.g., 115.1091, not 115.11)
4. **Commission precision**: 2 decimal places
5. **First line balance**: The first posting line (`Assets:Investment:SG-Moomoo:Securities` with no amount) auto-balances the cash component
6. **Chronological order**: Transactions should be in date order within the file

### Data Required from User

When user provides trade info, extract:

1. **Date**: Trade execution date
2. **Action**: Buy/Sell
3. **Ticker**: Stock symbol or option ticker
4. **Quantity**: Number of shares or contracts (convert contracts to shares for options: contracts × 100)
5. **Price**: Execution price per share
6. **Commission**: Total fees paid

### Reconciliation (CRITICAL)

When processing statements, verify balances match:

1. **Starting cash**: Must match beancount balance before adding transactions
2. **Ending cash**: Must match beancount balance after adding transactions
3. **Starting positions**: Must match beancount holdings before adding transactions
4. **Ending positions**: Must match beancount holdings after adding transactions

**Tolerance**: Cash discrepancy up to **$0.05 USD** is acceptable (due to rounding). Use a `Rounding` entry to reconcile small differences.

**If discrepancy > $0.05**: STOP and report to user. Do not proceed until resolved.

## Validation

After adding transactions, verify with:

```sh
bean-check main.bean
```

Format all files:

```sh
make format
```

View in web UI:

```sh
fava main.bean
```
